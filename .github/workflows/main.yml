name: Attempt to Maintain RDP VM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 4320 # Máximo permitido (72 horas), pero no garantiza la ejecución continua

    steps:
      - name: Get Previous Tailscale IP (if any)
        id: get_ip
        run: |
          $previous_ip = "${{ secrets.TAILSCALE_IP }}"
          if ($previous_ip) {
            echo "::set-output name=ip::$previous_ip"
            Write-Host "IP de Tailscale anterior encontrada: $previous_ip"
          } else {
            Write-Host "No se encontró IP de Tailscale anterior."
          }

      - name: Harden Windows
        run: |
          # Habilitar Firewall y bloquear RDP predeterminado (mantener)
          Enable-NetFirewallRule -DisplayName "Remote Desktop - User Mode (TCP-In)"
          Set-NetFirewallRule -DisplayName "Remote Desktop - User Mode (TCP-In)" -Enabled True -Action Block

      - name: Create Secure User
        run: |
          # Solicitar usuario y contraseña
          $username = Read-Host "Ingrese el nombre de usuario para RDP"
          if (!$username) {
            Write-Error "No se proporcionó un nombre de usuario. El workflow fallará."
            exit 1
          }

          $password = Read-Host -AsSecureString "Ingrese la contraseña para el usuario RDP"
          if (!$password) {
            Write-Error "No se proporcionó una contraseña. El workflow fallará."
            exit 1
          }

          # Crear el usuario con la contraseña proporcionada
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires

          # Agregar el usuario al grupo de usuarios de Escritorio Remoto
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username

          # Imprimir instrucciones (IMPORTANTE: No mostrar la contraseña en el log)
          Write-Host "VM creada correctamente."
          Write-Host "Usuario: $username"
          Write-Host "Por favor, guarda la contraseña que ingresaste de forma segura."

          # Guardar el nombre de usuario como secreto
          echo "::add-mask::$username"
          echo "::set-secret name=RDP_USERNAME::$username"

      - name: Install Tailscale
        run: |
          # (Mismo código de instalación de Tailscale)
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Connect Tailscale
        run: |
          # (Mismo código de conexión de Tailscale)
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$env:GITHUB_RUN_ID

          # Obtener la IP de Tailscale
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          if (!$tsIP) {
            Write-Error "No se pudo obtener la IP de Tailscale."
            exit 1
          }

          Write-Host "Dirección IP de Tailscale: $tsIP"

          # Guardar la IP en un secreto (para el próximo workflow)
          echo "::add-mask::$tsIP" # Mascarar la IP en el log
          echo "::set-secret name=TAILSCALE_IP::$tsIP" # Guardar como secreto

      - name: Configure RDP Firewall (Tailscale Only)
        run: |
          # (Mismo código de configuración de firewall, usando la IP actual)
          $tsIP = "${{ steps.connect_tailscale.outputs.tsIP }}" # Obtener la IP del paso anterior
          New-NetFirewallRule -DisplayName "RDP - Tailscale Only" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 3389 -RemoteAddress $tsIP
          Disable-NetFirewallRule -DisplayName "Remote Desktop - User Mode (TCP-In)"
